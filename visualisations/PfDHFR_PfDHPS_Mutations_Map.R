

# ============================================================
# Final Pfdhfr/Pfdhps Map Code
# ============================================================
# Author: Mulugeta Demisse
# Purpose: Generate a high-quality haplotype map for PfDHFR/PfDHPS
# ============================================================

# -----------------------------
# 1. Load Required Libraries
# -----------------------------
library(sf)        # Spatial data handling
library(dplyr)     # Data manipulation
library(ggplot2)   # Plotting
library(grid)      # For annotation_custom

# -----------------------------
# 2. Load Shapefiles and Data
# -----------------------------
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
Africa <- st_read("data/afric.shp")
border <- st_read("data/border.shp")
Et_region <- st_read("data/Et_region.shp")
Haplotype_all <- st_read("data/District_Haplotype_Joined.shp")
District <- st_read("data/District.shp")

# -----------------------------
# 3. Define Colors and Legend Labels
# -----------------------------
# -----------------------------
# 3. Define Colors and Legend Labels
# -----------------------------
colors_pfdhps <- c(
  "Sextuple"  = "#844da3",
  "Quintuple" = "#cd5e08",
  "Triple"    = "#2471a3",
  "Uncommon"  = "#9ed1ed",
  "Wildtype"  = "darkgrey"
)


# Legend labels: underline and bold only for IRN, last "I" normal
legend_labels <- c(
  expression(Sextuple(A*underline(bold("IRN"))*"I"/IS*underline(bold("GEG"))*A)),
  expression(Quintuple(A*underline(bold("IRN"))*"I"/IS*underline(bold("GE"))*AA)),
  expression(Triple(A*underline(bold("IRN"))*"I"/ISAKAA)),
  expression(Uncommon),
  expression(Wildtype(ANCSI/ISAKAA))
)

# -----------------------------
# 4. Map Boundaries
# -----------------------------
min_longitude <- 32.35396
max_longitude <- 48.28536
min_latitude <- 3
max_latitude <- 15

# -----------------------------
# 5. Compute Centroids and Label Offsets
# -----------------------------
Haplotype_all$centroid <- st_centroid(st_geometry(Haplotype_all))

offsets <- list(
  "Abergele" = c(0.5, 0.5), "Amibara" = c(0.1, 0.8), "Batu" = c(0, 0.6),
  "Dasenech" = c(0.8, 0.1), "Dera" = c(0.7, -0.4), "Fedis" = c(0.2, 0.7),
  "Fentale" = c(0.1, -0.8), "Gambella zuria" = c(-0.7, 0.2), "Gondar" = c(0.7, 0.1),
  "Guba" = c(-0.6, -0.2), "K. Humera" = c(-0.6, 0.1), "Metema" = c(-0.5, 0.1),
  "Mizan" = c(0.6, 0.4), "Pawe" = c(0.1, -0.5), "Selamago" = c(-0.6, 0.1)
)

offsets1 <- list(
  "Abergele" = c(0.7, -0.1), "Amibara" = c(0.46, 0.22), "Batu" = c(-0.1, -0.1),
  "Dasenech" = c(2.1, 0.1), "Dera" = c(0.5, 0.25), "Fedis" = c(0.5, 0.095),
  "Fentale" = c(0.8, -0.1), "Gambella zuria" = c(1, 0.2), "Gondar" = c(-0.5, -0.2),
  "Guba" = c(0.1, 0.5), "K. Humera" = c(0.8, 0.2), "Metema" = c(0.9, 0.3),
  "Mizan" = c(-0.4, 0.3), "Pawe" = c(0.1, 0.25), "Selamago" = c(0.8, 0.1)
)

district_centroids1 <- st_centroid(Haplotype_all)
label_positions <- data.frame(
  District = district_centroids1$District,
  x = st_coordinates(district_centroids1)[,1],
  y = st_coordinates(district_centroids1)[,2]
) %>%
  rowwise() %>%
  mutate(
    x_offset = offsets1[[District]][1],
    y_offset = offsets1[[District]][2],
    x_adjusted = x + x_offset,
    y_adjusted = y + y_offset
  )

# -----------------------------
# 6. CRS Alignment
# -----------------------------
common_crs <- st_crs(border)
Africa <- st_transform(Africa, common_crs)
Et_region <- st_transform(Et_region, common_crs)
Haplotype_all <- st_transform(Haplotype_all, common_crs)

# -----------------------------
# 7. Legend Dummy Data
# -----------------------------
legend_df <- data.frame(
  haplotype = names(colors_pfdhps),
  x = 1:length(colors_pfdhps),
  y = 1
)

# -----------------------------
# 8. Base Map
# -----------------------------
base_map <- ggplot() +
  geom_sf(data = Africa, fill = "gray80", color = "white", alpha = 0.3) +
  geom_sf(data = Et_region, fill = "white", color = "gray80", alpha = 0.9) +
  geom_sf(data = border, fill = NA, color = "gray80", size = 0.5) +
  geom_sf(data = Haplotype_all, fill = "#FEEBE7", color = "white", size = 0.2) +
  geom_text(
    data = label_positions,
    aes(x = x_adjusted, y = y_adjusted, label = District),
    size = 4.5, color = "gray20", family = "Calibri"
  ) +
  geom_sf_text(
    data = border,
    aes(label = Name_1),
    size = 3.5, color = "gray20", family = "Calibri"
  ) +
  coord_sf(
    xlim = c(min_longitude, max_longitude),
    ylim = c(min_latitude, max_latitude),
    expand = FALSE
  ) +
  geom_tile(
    data = legend_df,
    aes(x = x, y = y, fill = haplotype),
    width = 0.5, height = 0.5
  ) +
  scale_fill_manual(
    values = colors_pfdhps,
    breaks = names(colors_pfdhps),
    labels = legend_labels,
    name = expression(italic("Pf")*"DHFR/"*italic("Pf")*"DHPS")
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    axis.text = element_text(size = 14),
    axis.ticks = element_blank(),
    legend.position = c(1, 0.97),
    legend.justification = c("right", "top"),
    legend.title = element_text(face = "bold", size = 12),
    legend.text.align = 0
  )

# -----------------------------
# 9. Add Pie Charts for Haplotypes
# -----------------------------
for (i in 1:nrow(Haplotype_all)) {
  district <- Haplotype_all$District[i]
  centroid <- st_coordinates(Haplotype_all$centroid[i, ])
  offset <- offsets[[district]]
  x_offset <- ifelse(!is.null(offset), offset[1], 0)
  y_offset <- ifelse(!is.null(offset), offset[2], 0)
  adjusted_x <- centroid[1] + x_offset
  adjusted_y <- centroid[2] + y_offset
  
  pie_df <- Haplotype_all %>%
    filter(District == district & Haplotype %in% names(colors_pfdhps)) %>%
    select(Haplotype, Prevalence)
  
  if (nrow(pie_df) > 0) {
    pie_chart <- ggplot(pie_df, aes(x = "", y = Prevalence, fill = Haplotype)) +
      geom_bar(stat = "identity", width = 1) +
      coord_polar(theta = "y") +
      scale_fill_manual(values = colors_pfdhps) +
      theme_void() +
      theme(legend.position = "none")
    
    pie_grob <- ggplotGrob(pie_chart)
    pie_size <- 0.6
    
    base_map <- base_map +
      annotation_custom(
        grob = pie_grob,
        xmin = adjusted_x - pie_size, xmax = adjusted_x + pie_size,
        ymin = adjusted_y - pie_size, ymax = adjusted_y + pie_size
      )
  }
}

# -----------------------------
# 10. Save Outputs
# -----------------------------
print(base_map)

output_base <- "Pfdhfr_Pfdhps_Map_Mutations_Final"
ggsave(paste0(output_base, ".png"), plot = base_map, dpi = 300, width = 900/96, height = 577/96)
ggsave(paste0(output_base, ".pdf"), plot = base_map, dpi = 300, width = 900/96, height = 577/96, device = cairo_pdf)

